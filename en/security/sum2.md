# 授权用户对数据的访问控制

MLSQL对任何接入的数据源，任何形式的资源访问都可以抽象成库表，并且使用[库-表-字段-操作]形式实现权限认证。
值得注意的是，这种认证直接集成在语言层面。

库表是资源的表现形式，列则表达了MLSQL对数据访问控制的粒度。

而在`操作`上，我们将其分成两类：

1. 数据的操作，比如你是不是能对一张表进行load/save/directQuery/create/drop/insert/update/select/set
2. 语言工具。比如你是不是能够使用`TfIdfInPlace`工具，如果你没有被授权使用`TfIdfInPlace`工具,你就无法使用该工具在MLSQL中做任何事情。


## HDFS如何抽象成库表

HDFS 可以理解是一个default数据库。对应的每个路径则是一个表。默认用户主目录下的内容都是可以被访问的。对于任何非主目录则需要单独进行授权。
比如，如果你被授权了 `/tmp/work` 目录,那么你对/tmp/work以及所有的子目录具有读或者写权限。


## 结构化数据库如何抽象成库表

对于 MySQL、Hive、ES、HBase 等数据源默认就是库表形态的。

* MySQL 和 Hive 数据源：数据库表名对应权限认证的库表名
* HBase 数据源：namespace 名称对应库名，HBase 表名对应表名
* ES 数据源：ES 索引名称对应库名， ES 索引下的不同类型对应表名

> **[info] 一些特例情况**
>
>  考虑到ES经常会拆分索引，ES数据源应当支持正则匹配权限认证：
>  比如说您拥有索引名为「es_index_test」的权限，那么您同时拥有「es_index_test-2020.09.27」与「es_index_test-2020-09-27」的权限（具体日期随意）
>

## 授权规则

得益于MLSQL的良好语法，比如，当我们授权 hive表 db1.table1 的load权限给user1时，此时用户运行如下语句就会被通过：

```
load hive.`db1.table1` as table1;
```

否则就不会得到通过。MLSQL还可以支持到列级别的控制，尽管我们授权 hive表 db1.table1 的load权限给user1，我们也可以同时限制他能够看到哪些列，亦或是对列进行脱敏。

## 实现机制

MLSQL会在两个阶段收集校验信息。第一个是做语法预处理的时候，他会抽取出用户所要访问的资源，并且将其发送给指定的权限校验服务。
第二个阶段是，他会在解析运行时执行校验，这主要服务于列权限。系统在执行Load的时候，会根据权限服务器，过滤掉不符合权限要求的列。同样在解析运行时
执行校验的还有ET组件，譬如我们前面提到的`TfIdfInPlace`工具。

权限服务可以是用户自己开发的，也可以是官方提供的。
